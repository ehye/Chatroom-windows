<!DOCTYPE html>
<html>

    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8">
        <title>Web sockets test</title>
        <link rel="stylesheet" type="text/css" href="vendor/css/bootstrap.css">
        <style type="text/css">
            * {
                /*border: 1px solid red;*/
            }

            .container {
                padding-right: 0px; 
                padding-left: 0px; 
                height: 800px;
            }

            .nav {
                border-top-left-radius: 0.25rem !important;
                border-top-right-radius: 0.25rem !important;
            }

            .row.col-md-12, .col-md-9 {
                margin-right: 0px; 
                margin-left: 0px; 
                padding-right: 0px; 
                padding-left: 0px; 
            }

            .list-group.col-md-3 {
                padding-right: 0px; 
                padding-left: 0px;
                border-right: 2px solid #E9EBED;
                overflow: hidden;
            }

            a.list-group-item.list-group-item-action {
                border-radius: 0;
            }

            .text_area {
                height: 700px;
                overflow: auto;
                border-radius: 0;
                border: 0;
            }

            p.badge.badge-success{
                font-size: 100%;
                font-weight: normal;
                line-height: unset;
            }

        </style>
        <script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.js"></script>
        <script src="vendor/js/bootstrap.bundle.js" type="text/javascript"></script>
    </head>

    <body style="background: #e7ebf0">
        <div>
            <input type="text" id="Connection" value="127.0.0.1:6017/Chat" />
            <input type="text" id="txtName" value="yjw" />
            <button id='ToggleConnection' type="button" onclick='ToggleConnectionClicked();'>连接</button>
        </div>
        <div class="container fixed-top my-5 bg-light shadow rounded">
            <nav class="nav navbar-expand-lg bg-dark pl-4">
                <a class="navbar-brand text-white" href="#">Webchat</a>
            </nav>

            <div class="row col-md-12">
                <div class="list-group col-md-3" id="list">
                    <!-- <div class="p-4">
                        <input type="text" class="form-control form-control-sm" placeholder="Search">
                    </div> -->
                    <!-- <a id="list-item" href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        Cras justo odio<span class="badge badge-danger badge-pill">1</span></a> -->
                </div>
                <div class="col-md-9">
                    <div id="LogContainer" class="text_area form-control"></div>
                    <div class="input-group">
                        <input type="text" id="DataToSend" class="form-control" placeholder="Write a message">
                        <div class="input-group-append">
                            <button id="btn_send" class="btn btn-outline-secondary" type="button" onclick="SendDataClicked();">Send</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </body>

    <script type="text/javascript">
        var ws;
        var SocketCreated = false;
        var isUserloggedout = false;
        var idNameMap = new Map();
        var _uid;

        function WSonOpen() {
            Log("Connection established", "OK");

            var j = "{\"user_id\":" + _uid + ",\"name\":\"" +
                $("#txtName")[0].value +
                "\",\"type\":\"connection\",\"message\":\"\"}";

            //ws.send(j);
        };

        function WSonMessage(event) {
            ProcessTextMessage(event.data);
        };

        function WSonClose(event) {
            if (isUserloggedout)
                Log("disconnect, reason:" + event.reason);

            $("#ToggleConnection")[0].innerHTML = "连接";
        };

        function WSonError() {
            Log("远程连接中断。", "ERROR");
        };

        function ToggleConnectionClicked() {
            if (SocketCreated && (ws.readyState == 0 || ws.readyState == 1)) {
                SocketCreated = false;
                isUserloggedout = true;
                ws.close(1000);
                $("#list").empty();
            } else {
                Log("Connectting ...");
                try {
                    if ("WebSocket" in window) {
                        ws = new WebSocket("ws://" + $("#Connection")[0].value + "?name=" + $("#txtName")[0].value);
                    } else if ("MozWebSocket" in window) {
                        ws = new MozWebSocket("ws://" + $("#Connection")[0].value);
                    }

                    SocketCreated = true;
                    isUserloggedout = false;
                } catch (ex) {
                    Log(ex, "ERROR");
                    return;
                }
                $("#ToggleConnection")[0].innerHTML = "断开";
                ws.onopen = WSonOpen;
                ws.onmessage = WSonMessage;
                ws.onclose = WSonClose;
                ws.onerror = WSonError;
            }
        };

        function SendDataClicked() {
            if ($("#DataToSend")[0].value.trim() != "") {

                var j = "{\"user_id\":\"52704\",\"name\":\"" +
                    $("#txtName")[0].value +
                    "\",\"type\":\"message\",\"message\":\"" +
                    $("#DataToSend")[0].value + "\"}";

                ws.send(j);
                $("#DataToSend")[0].value = "";
            }
        };

        function ProcessTextMessage(data) {
            var j = JSON.parse(data);
            var name = "<br/>" + j.name + "<br/>";
            var msg = '<p class="badge badge-success">'+j.message+"</p>";

            switch (j.type) {
                case ("connection"):
                    _uid = j.user_id;
                    idNameMap.set(j.user_id, j.name);
                    $("#list").append('<a id="' + j.name + '" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">'+
                        j.name+'<span class="badge badge-danger badge-pill"></span></a>');
                    // Log(j.name + " join the chat");
                    break;
                case ("list"):
                    
                    break;
                case ("message"):
                    $("#LogContainer")[0].innerHTML += name;
                    $("#LogContainer")[0].innerHTML += msg;
                    break;
                case ("disconnect"):
                    idNameMap.delete(j.name);
                    $("#"+j.name).remove();
                    // Log(j.name + " disconnect");
                    break;
                default:
                    if(j[0] == "list")
                    for (var i = j.length - 1; i > 0; i--) {
                        $("#list").append('<a id="' + j[i] + '" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">'+
                        j[i]+'<span class="badge badge-danger badge-pill"></span></a>');
                    }
                    else {
                        Log(JSON.stringify(j));
                    }
                    break;
            }
            $("#LogContainer")[0].scrollTop = $("#LogContainer")[0].scrollHeight;
        };

        function Log(Text, MessageType) {
            // if (MessageType == "OK") Text = "<span style='color: green;'>" + Text + "</span>";
            // if (MessageType == "ERROR") Text = "<span style='color: red;'>" + Text + "</span>";
            
            var msg = "<b>"+Text+"</b>";
            $("#LogContainer")[0].innerHTML = $("#LogContainer")[0].innerHTML + msg + "<br/>";
            $("#LogContainer")[0].scrollTop = $("#LogContainer")[0].scrollHeight;
        };

        $(document).ready(function() {

            var _to;
            var WebSocketsExist = true;
            try {
                var dummy = new WebSocket("wss://echo.websocket.org");
            } catch (ex) {
                try {
                    webSocket = new MozWebSocket("wss://echo.websocket.org");
                } catch (ex) {
                    WebSocketsExist = false;
                }
            }

            if (WebSocketsExist) {
                Log("您的浏览器支持WebSocket. 您可以尝试连接到聊天服务器!", "OK");
                // $("#Connection")[0].value = "127.0.0.1:6017/Chat";
            } else {
                Log("您的浏览器不支持WebSocket。请选择其他的浏览器再尝试连接服务器。", "ERROR");
                $("#ToggleConnection")[0].disabled = true;
            }

            $("#DataToSend").keypress(function(event) {
                if (event.keyCode == 13) {
                    $("#btn_send").click();
                    event.preventDefault();
                }
            })

            // $("#list-item").click(function(event) {
            //     _to = 'dd'
            //     Log(_to);
            // });
        });
    </script>

</html>